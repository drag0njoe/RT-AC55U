#include <linux/pci.h>

#include "xhci.h"

static struct table_item cfg_items_v00510[] = {
	{0x44, 0x00000003},
	{0x2c, 0x70231b6f},
	{0x68, 0x19120176},
	{0x68, 0x18005000},
	{0x68, 0x190001c1},
	{0x68, 0x18005000},
	{0x68, 0x197001c8},
	{0x68, 0x18005000},
	{0x68, 0x197001c9},
	{0x68, 0x18005000},
	{0x68, 0x199801d4},
	{0x68, 0x18005000},
	{0x68, 0x192c01d5},
	{0x68, 0x18005000},
	{0x68, 0x198c01d8},
	{0x68, 0x18005000},
	{0x68, 0x198401d9},
	{0x68, 0x18005000},
	{0x68, 0x190c01e0},
	{0x68, 0x18005000},
	{0x68, 0x199a01e1},
	{0x68, 0x18005000},
	{0x68, 0x19c001e4},
	{0x68, 0x18005000},
	{0x68, 0x194001c1},
	{0x68, 0x18005000},
	{0x68, 0x193e01c5},
	{0x68, 0x18005000},
	{0x68, 0x198001c1},
	{0x68, 0x18005000},
	{0x68, 0x190401d5},
	{0x68, 0x18005000},
	{0x68, 0x19c001c1},
	{0x68, 0x18005000},
	{0x68, 0x198001d1},
	{0x68, 0x18005000},
	{0x68, 0x190401c4},
	{0x68, 0x18005000},
	{0x68, 0x194a01d8},
	{0x68, 0x18005000},
	{0x68, 0x19d001c1},
	{0x68, 0x18005000},
	{0x68, 0x190401c4},
	{0x68, 0x18005000},
	{0x68, 0x194a01d8},
	{0x68, 0x18005000},
	{0x68, 0x19975000},
	{0x68, 0x198a5003},
	{0x68, 0x19305004},
	{0x68, 0x19005005},
	{0x68, 0x19045007},
	{0x68, 0x1910500c},
	{0x68, 0x19f05022},
	{0x68, 0x10000000},
	{0x44, 0x00000001},
};
#define CFG_ITEMS_V00510	((int)(sizeof(cfg_items_v00510)/sizeof(cfg_items_v00510[0])))

static struct table_item mmio_items_v00510[] = {
	{0x1811, 0x60},
	{0x4000, 0x10},
	{0x4001, 0x05},
	{0x4002, 0x60},
	{0x4003, 0x20},
	{0x1811, 0x61},
	{0x4022, 0x10},
	{0x4040, 0x0e},
	{0x4041, 0x01},
	{0x4048, 0x81},
	{0x4049, 0xff},
	{0x404a, 0x81},
	{0x404b, 0xff},
	{0x404d, 0x09},
	{0x4060, 0x07},
	{0x4063, 0x03},
	{0x40a0, 0xa4},
	{0x40b0, 0xa4},
	{0x40c0, 0x0e},
	{0x40c1, 0x01},
	{0x40c8, 0x81},
	{0x40c9, 0xff},
	{0x40ca, 0x81},
	{0x40cb, 0xff},
	{0x40cd, 0x09},
	{0x40cf, 0x0c},
	{0x404f, 0x0d},
	{0x4072, 0xbe},
	{0x4075, 0x90},
	{0x4076, 0x0a},
	{0x4080, 0xff},
	{0x4081, 0xff},
	{0x4084, 0xff},
	{0x4085, 0xff},
	{0x4090, 0xff},
	{0x4091, 0xff},
	{0x4094, 0xff},
	{0x4095, 0xff},
	{0x40f3, 0x80},
	{0x40a1, 0x55},
	{0x40b1, 0x55},
};
#define MMIO_ITEMS_V00510	((int)(sizeof(mmio_items_v00510)/sizeof(mmio_items_v00510[0])))

void xhci_init_ej168_v00510(struct xhci_hcd *xhci)
{
	int i, error_flag = 0;
	struct usb_hcd *hcd = xhci_to_hcd(xhci);
	struct pci_dev *pdev = to_pci_dev(hcd->self.controller);
	u8 reg8 = 0;

	pci_read_config_byte(pdev, 0x9b, &reg8);
	reg8 = (reg8 & 0xc0) | 0x80;
	pci_write_config_byte(pdev, 0x9b, reg8);
	pci_read_config_byte(pdev, 0x9c, &reg8);
	reg8 = (reg8 & 0x0c) | 0x08;
	pci_write_config_byte(pdev, 0x9c, reg8);
	pci_read_config_byte(pdev, 0xec, &reg8);
	reg8 |= 0x04;
	pci_write_config_byte(pdev, 0xec, reg8);
	pci_read_config_byte(pdev, 0xf5, &reg8);
	reg8 |= 0x40;
	pci_write_config_byte(pdev, 0xf5, reg8);

	for (i = 0; i < CFG_ITEMS_V00510; i++) {
		pci_write_config_dword(pdev, cfg_items_v00510[i].offset,
			cfg_items_v00510[i].value);
		if (cfg_items_v00510[i].offset == 0x68 &&
			cfg_items_v00510[i].value != 0x18005000)
			mdelay(1);
	}

	for (i = 0; i < MMIO_ITEMS_V00510; i++) {
		xhci_writeb(xhci, mmio_items_v00510[i].value,
			mmio_items_v00510[i].offset);
	}

	for (i = 0; i < MMIO_ITEMS_V00510; i++) {
		if ((0x1811 != mmio_items_v00510[i].offset) && (0 == error_flag)) {
			reg8 = xhci_readb(xhci, mmio_items_v00510[i].offset);
			if (reg8 != (u8)mmio_items_v00510[i].value)
				error_flag = 1;
		}
	}

	if (error_flag) {
		for (i = 0; i < MMIO_ITEMS_V00510; i++) {
			if (0x1811 != mmio_items_v00510[i].offset) {
				reg8 = xhci_readb(xhci, mmio_items_v00510[i].offset);
				xhci_err(xhci, "%s - @%04x %02x\n",
					__func__, mmio_items_v00510[i].offset, reg8);
			}
		}
	}
}

